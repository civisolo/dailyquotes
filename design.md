# 设计说明（design.md）

## 产品定位
DailyMind 致力于为用户提供每日正念金句、白噪音放松体验，帮助用户提升专注、情绪和幸福感。

## 主要设计思路
- 首页：单条金句卡片，滑动切换，支持TTS朗读、收藏、分享
- 白噪音：可随时播放/切换，后台管理可上传，前端自动循环播放
- 金句管理：支持批量加载、分页、按类别切换
- 收藏/历史：本地存储，便于回顾
- 管理后台：Streamlit实现，支持金句/白噪音的增删改查

## 交互流程
1. 启动App，首页自动加载一批金句，滑动切换
2. 可切换金句类别，自动刷新内容
3. 点击TTS按钮朗读金句，支持收藏/分享
4. 底部可切换白噪音、收藏、历史、主题
5. 管理后台可维护金句和白噪音内容

## UI风格
- 简洁、温暖、治愈系色彩
- 卡片式布局，圆角、阴影
- 响应式适配多端

## 技术选型
- 前端：Flutter + Riverpod
- 后端：FastAPI + MongoDB + Streamlit
- 音频：audioplayers
- 状态管理：Provider/StateNotifier

## 未来可扩展
- 用户体系、云端收藏/历史
- 金句/白噪音推荐算法
- 主题/皮肤切换
- 多语言支持

## 系统架构

### 整体架构
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Flutter   │     │   FastAPI   │     │  Streamlit  │
│   Client    │◄────┤    API      │◄────┤    Admin    │
└─────────────┘     └─────────────┘     └─────────────┘
       ▲                   ▲                   ▲
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────┐
│                     MongoDB                         │
└─────────────────────────────────────────────────────┘
```

### 技术选型
1. 前端（Flutter）
   - 状态管理：Riverpod
   - 音频播放：just_audio
   - 本地存储：Hive
   - 网络请求：dio

2. 后端（FastAPI）
   - 数据库：MongoDB
   - AI服务：OpenAI API
   - 文件存储：本地文件系统
   - 代理配置：系统级代理

3. 管理后台（Streamlit）
   - UI框架：Streamlit
   - 文件上传：Streamlit文件上传组件
   - 数据展示：Streamlit表格组件

## 数据流

### 金句生成流程
1. 管理后台发起生成请求
2. 后端调用OpenAI API
3. 生成结果保存到MongoDB
4. 移动端从API获取金句
5. 播放时调用TTS生成语音

### 白噪音管理流程
1. 管理后台上传音频文件
2. 文件保存到本地存储
3. 文件信息保存到MongoDB
4. 移动端从API获取白噪音列表
5. 播放时从服务器获取音频文件

## 安全设计

### 数据安全
1. 环境变量管理
   - 使用.env文件存储敏感信息
   - 不同环境使用不同的配置文件

2. 文件安全
   - 限制上传文件大小
   - 验证文件类型
   - 安全的文件存储路径

3. API安全
   - 请求频率限制
   - 错误处理机制
   - 代理配置保护

## 性能优化

### 前端优化
1. 音频优化
   - 预加载机制
   - 缓存策略
   - 状态同步优化

2. UI优化
   - 懒加载
   - 状态管理优化
   - 动画性能优化
   - 底部TabBar溢出问题已修复

### 后端优化
1. 数据库优化
   - 索引优化
   - 查询优化
   - 连接池管理

2. API优化
   - 缓存策略
   - 并发控制
   - 错误重试机制

## 扩展性设计

### 功能扩展
1. 用户系统
   - 用户认证
   - 权限管理
   - 个性化设置

2. 内容管理
   - 分类系统
   - 推荐系统
   - 内容审核

### 技术扩展
1. 部署扩展
   - 容器化支持
   - 负载均衡
   - 监控系统

2. 集成扩展
   - 第三方服务集成
   - 数据分析
   - 推送通知

## 总体架构
- 前后端分离：Flutter 客户端 + FastAPI 后端 + Streamlit 管理后台
- MongoDB 数据库，所有数据按设备UUID隔离，无需用户注册/登录
- 日志系统、静态文件服务、文件上传、主题切换、本地存储、引导页

## 主要模块
1. 设备标识系统
   - 每台设备首次启动自动生成UUID，所有数据（收藏、历史、偏好）均与UUID关联
   - 无需用户注册/登录，极简体验
2. 金句与白噪音
   - 分类管理、批量生成、播放、收藏、历史记录
   - 支持本地缓存与预加载
3. 管理后台
   - 金句/白噪音内容管理、文件上传
4. 日志与监控
   - 统一日志收集，支持调试与问题追踪
5. 主题与引导
   - 多主题切换、首次启动引导页

## 数据流
- 设备端通过UUID请求/同步数据
- 金句/白噪音内容通过API获取，支持分页、分类、缓存
- 收藏/历史/偏好等本地存储，必要时同步到后端

## 安全设计
- 仅设备UUID，无用户隐私数据
- 文件上传校验、API权限控制

## 性能与扩展
- 音频预加载与缓存机制（进行中）
- MongoDB索引优化、API分页
- 后续可扩展内容推荐、第三方服务接入

## 下一步设计
- 音频缓存/预加载机制
- 更细致的错误处理与自动重试
- API缓存策略
- UI/UX 动画与交互优化
- 推荐系统优化

## 国际化（i18n）
- 使用 easy_localization 实现多语言，支持中/英/日
- 语言包统一放在 assets/lang/
- 所有页面、弹窗、TabBar、提示等均用 .tr() 获取翻译
- 语言设置支持"跟随系统"或手动切换
- 历史时间、通知时间等全部国际化

## 状态管理
- 全部采用 Riverpod，Provider 统一在 lib/providers/
- 复杂状态用 StateNotifierProvider
- 语言、主题、音量、收藏、历史等均有独立 Provider
- 音量调节 Provider 支持 TTS/白噪音分别设置，滑块拖动实时生效

## UI/UX
- Material Design 风格，支持深色/浅色/多色主题
- 响应式布局，适配多端
- 主要页面：首页、收藏、历史、主题、设置
- TabBar、弹窗、按钮等全部国际化
- 历史页面时间显示自动本地化

## 本地存储
- 使用 Hive 持久化收藏、历史、设置、语言、音量等
- 通知时间、音量等设置本地保存

## 日志
- logs/ 目录保存调试和运行日志，便于问题追踪

## 其它
- 代码风格规范，详见 flutter.mdc 规则
- 详见 structrues.md、apis.md、database.md 

## 主题与配色
- 使用 FlexColorScheme 支持多套主题和自定义配色
- 支持明暗模式切换

## 收藏
- 收藏按钮可直接添加/移除金句，最新收藏显示在顶部
- 收藏数据本地持久化（Hive）

## 国际化
- 使用 easy_localization，支持中/英/日三语
- 多语言资源位于 assets/lang/

## 白噪音
- 支持多种白噪音播放

## 已移除
- 历史相关设计

## 推送提醒
- 支持所有平台的本地定时推送（flutter_local_notifications）
- macOS 需初始化时区（flutter_timezone）
- 设置页可开启每日提醒

## 通知系统设计

### 通知功能
1. 默认通知设置
   - 首次启动应用时自动启用通知
   - 默认从早上 8:00 开始，每两小时推送一次
   - 一天最多推送 8 次
   - 每次推送随机选择一条金句

2. 通知管理
   - 在设置页面可以：
     - 开启/关闭通知
     - 修改通知起始时间
   - 通知设置实时生效
   - 支持多语言通知内容

3. Badge 计数管理
   - 应用启动时自动清除 badge 计数
   - 点击通知进入应用时清除 badge 计数
   - 支持 iOS 和 macOS 平台

### 通知流程
1. 应用启动流程
   ```
   应用启动
   ↓
   初始化通知服务
   ↓
   清除 badge 计数
   ↓
   检查通知设置
   ↓
   如果是首次启动 → 设置默认通知
   如果已有设置 → 根据设置启用/禁用通知
   ```

2. 通知点击流程
   ```
   用户点击通知
   ↓
   进入应用
   ↓
   清除 badge 计数
   ```

3. 通知设置流程
   ```
   用户修改设置
   ↓
   保存设置
   ↓
   请求通知权限
   ↓
   根据设置启用/禁用通知
   ↓
   显示设置保存成功提示
   ```

## 分类持久化设计

### 功能说明
1. 分类选择持久化
   - 使用 Hive 存储用户选择的分类
   - 应用启动时自动加载上次选择的分类
   - 分类切换时实时保存

2. 通知系统集成
   - 本地推送时从用户选择的分类中随机选择内容
   - 通知内容显示当前分类信息
   - 点击通知时记录分类信息

### 数据存储
1. Hive Box: 'settings'
   - Key: 'selected_category'
   - Value: 分类名称（String）
   - 默认值: '综合'

### 状态管理
1. CategoryProvider
   - 管理当前选中的分类
   - 提供分类切换方法
   - 自动加载保存的分类

### 流程
1. 应用启动流程
   ```
   应用启动
   ↓
   初始化 Hive
   ↓
   加载保存的分类
   ↓
   更新 UI 显示
   ```

2. 分类切换流程
   ```
   用户选择新分类
   ↓
   保存到 Hive
   ↓
   更新 Provider 状态
   ↓
   刷新 UI 显示
   ↓
   更新通知内容
   ```

3. 通知推送流程
   ```
   定时触发通知
   ↓
   读取保存的分类
   ↓
   从对应分类随机选择内容
   ↓
   发送通知
   ```

### 金句卡片字体大小设计
- 支持 small/medium/large 三档，分别为28/36/44
- 由 fontSizeProvider 控制，用户可在设置中切换
- UI 会自动响应字号变化

## 其它
- 代码风格规范，详见 flutter.mdc 规则
- 详见 structrues.md、apis.md、database.md 

## 主题与配色
- 使用 FlexColorScheme 支持多套主题和自定义配色
- 支持明暗模式切换

## 收藏
- 收藏按钮可直接添加/移除金句，最新收藏显示在顶部
- 收藏数据本地持久化（Hive）

## 国际化
- 使用 easy_localization，支持中/英/日三语
- 多语言资源位于 assets/lang/

## 白噪音
- 支持多种白噪音播放

## 已移除
- 历史相关设计

## 推送提醒
- 支持所有平台的本地定时推送（flutter_local_notifications）
- macOS 需初始化时区（flutter_timezone）
- 设置页可开启每日提醒

## 通知系统设计

### 通知功能
1. 默认通知设置
   - 首次启动应用时自动启用通知
   - 默认从早上 8:00 开始，每两小时推送一次
   - 一天最多推送 8 次
   - 每次推送随机选择一条金句

2. 通知管理
   - 在设置页面可以：
     - 开启/关闭通知
     - 修改通知起始时间
   - 通知设置实时生效
   - 支持多语言通知内容

3. Badge 计数管理
   - 应用启动时自动清除 badge 计数
   - 点击通知进入应用时清除 badge 计数
   - 支持 iOS 和 macOS 平台

### 通知流程
1. 应用启动流程
   ```
   应用启动
   ↓
   初始化通知服务
   ↓
   清除 badge 计数
   ↓
   检查通知设置
   ↓
   如果是首次启动 → 设置默认通知
   如果已有设置 → 根据设置启用/禁用通知
   ```

2. 通知点击流程
   ```
   用户点击通知
   ↓
   进入应用
   ↓
   清除 badge 计数
   ```

3. 通知设置流程
   ```
   用户修改设置
   ↓
   保存设置
   ↓
   请求通知权限
   ↓
   根据设置启用/禁用通知
   ↓
   显示设置保存成功提示
   ```

## 分类持久化设计

### 功能说明
1. 分类选择持久化
   - 使用 Hive 存储用户选择的分类
   - 应用启动时自动加载上次选择的分类
   - 分类切换时实时保存

2. 通知系统集成
   - 本地推送时从用户选择的分类中随机选择内容
   - 通知内容显示当前分类信息
   - 点击通知时记录分类信息

### 数据存储
1. Hive Box: 'settings'
   - Key: 'selected_category'
   - Value: 分类名称（String）
   - 默认值: '综合'

### 状态管理
1. CategoryProvider
   - 管理当前选中的分类
   - 提供分类切换方法
   - 自动加载保存的分类

### 流程
1. 应用启动流程
   ```
   应用启动
   ↓
   初始化 Hive
   ↓
   加载保存的分类
   ↓
   更新 UI 显示
   ```

2. 分类切换流程
   ```
   用户选择新分类
   ↓
   保存到 Hive
   ↓
   更新 Provider 状态
   ↓
   刷新 UI 显示
   ↓
   更新通知内容
   ```

3. 通知推送流程
   ```
   定时触发通知
   ↓
   读取保存的分类
   ↓
   从对应分类随机选择内容
   ↓
   发送通知
   ```

## 已移除 SharedPreferences，所有本地设置统一由 Hive 管理。 